# overlays/your-overlay/deployment-to-rollout-patch.yaml
- op: replace
  path: /kind
  value: Rollout
- op: replace
  path: /apiVersion
  value: argoproj.io/v1alpha1
- op: add
  path: /spec/strategy
  value: {}
- op: add
  path: /spec/strategy/canary
  value: {}
- op: add
  path: /spec/strategy/canary/stableMetadata
  value: 
    labels:
        role: stable
- op: add
  path: /spec/strategy/canary/canaryMetadata
  value: 
    labels:
        role: canary
- op: add
  path: /spec/strategy/canary/steps
  value:
    - setWeight: 30
    - pause:
        duration: 3m
    - setWeight: 60
    - pause:
        duration: 3m
    - setWeight: 100
    - pause:
        duration: 10s
  # Sets header based route with specified header values
    # Setting header based route will send all 100 traffic to the canary for the requests 
    # O with a specified header, in this case request header "version":"2"
    # (supported only with trafficRouting, for Istio only at the moment)
    - setHeaderRoute:
        # Name of the route that will be created by argo rollouts this must also be configured
        # in spec.strategy.canary.trafficRouting.managedRoutes
        name: "header-route-1"
        # The matching rules for the header route, if this is missing it acts as a removal of the route.
        match:
            # headerName The name of the header to apply the match rules to.
          - headerName: "version"
            headerValue:
                # Exact will only match if the header value is exactly the same
                exact: "2"


